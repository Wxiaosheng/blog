### 导航流程：从输入 URL 到页面展示，这中间发生了什么？

#### 复习
* 浏览器进程主要负责，用户交互、子进程管理 和 文件存储 等功能
* 网络进程是面向 渲染进程 和 浏览器进程等 提供网络下载功能
* 渲染进程主要职责是 把从网络上下载的 HTML、CSS、JavaScript、图片等文件解析成可以显示和交互的页面

**用户发出 URL 请求，到页面开始解析的这个过程，叫做导航**  

##### 1、用户输入
* 用户输入 **搜索内容**，合成新的带搜索关键字的 URL
* 用户输入 **URL**， 根据规则把 URL 补充完整
* 当前页面即将要被替换成新的页面，且会触发当前页面的 beforeunload 事件
* 当浏览器刚开始加载一个地址之后，标签页上的图标便进入了加载状态。但此时图中页面显示的依然是之前打开的页面内容，并没立即替换为极客时间的页面。因为需要等待提交文档阶段，页面内容才会被替换

##### 2、URL 请求过程
* 浏览器进程会通过进程间通信（IPC）把 URL 请求发送至网络进程，网络进程接收到 URL 请求后，会在这里发起真正的 URL 请求流程
* 网络进程会查找本地缓存是否缓存了该资源。如果有缓存资源，那么直接返回资源给浏览器进程；如果在缓存中没有查找到资源，那么直接进入网络请求流程
* 请求前的第一步是要进行 DNS 解析，以获取请求域名的服务器 IP 地址。如果请求协议是 HTTPS，那么还需要建立 TLS 连接
* 利用 IP 地址和服务器建立 TCP 连接，连接建立之后，浏览器端会构建请求行、请求头等信息，并把和该域名相关的 Cookie 等数据附加到请求头中，然后向服务器发送构建的请求信息
* 服务器接收到请求信息后，会根据请求信息生成响应数据（包括响应行、响应头和响应体等信息），并发给网络进程。等网络进程接收了响应行和响应头之后，就开始解析响应头的内容了
* 重定向，在导航过程中，如果服务器响应行的状态码包含了 301、302 一类的跳转信息，网络进程会从响应头的 Location 字段里面读取重定向的地址继续导航；如果响应行是 200，那么表示浏览器可以继续处理该请求
* 响应数据类型处理，Content-Type 是 HTTP 头中一个非常重要的字段， 它告诉浏览器服务器返回的响应体数据是什么类型
  * text/html - html 文件
  * application/octet-stream - 字节流类型，通常情况下，浏览器会按照下载类型来处理该请求，同时该 URL 请求的导航流程就此结束

##### 3、准备渲染进程
* 默认情况下，Chrome 会为每个页面分配一个渲染进程，但如果从一个页面打开了另一个新页面，而新页面和当前页面属于同一站点的话，那么新页面会复用父页面的渲染进程
  * 同一站点： 根域名 + 协议
* 渲染进程准备好之后，还不能立即进入文档解析状态，因为此时的文档数据还在网络进程中，并没有提交给渲染进程

##### 4、提交文档
就是指 浏览器进程 将 网络进程 接收到的 HTML 数据提交给 渲染进程，具体步骤：
* 首先当浏览器进程接收到网络进程的响应头数据之后，便向渲染进程发起“提交文档”的消息
* 渲染进程接收到“提交文档”的消息后，会和网络进程建立传输数据的“管道”
* 等文档数据传输完成之后，渲染进程会返回“确认提交”的消息给浏览器进程
* 浏览器进程在收到“确认提交”的消息后，会更新浏览器界面状态，包括了安全状态、地址栏的 URL、前进后退的历史状态，并更新 Web 页面

**到这里，一个完整的导航流程就“走”完了，这之后就要进入渲染阶段了**

##### 5、渲染阶段
一旦文档被提交，渲染进程便开始页面解析和子资源加载了， 具体过程 参见 1.5.md 和 1.6.md


#### 总结
* 服务器可以根据响应头来控制浏览器的行为，如跳转、网络数据类型判断
* Chrome 默认采用每个标签对应一个渲染进程，但是如果两个页面属于同一站点，那这两个标签会使用同一个渲染进程
* 浏览器的导航过程涵盖了从用户发起请求到提交文档给渲染进程的中间所有阶段
  * 导航流程很重要，它是网络加载流程和渲染流程之间的一座桥梁，如果你理解了导航流程，那么你就能完整串起来整个页面显示流程，这对于你理解浏览器的工作原理起到了点睛的作用

